
<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>ioHub.client &mdash; ioHub 0.6rc1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap-2.2.1.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/bootstrap-responsive-2.2.1.min.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.6rc1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/..\..\Python-2.7.3\Lib\site-packages\IPython\frontend\html\notebook\static\mathjax"></script>
    <script type="text/javascript" src="../../_static/js/bootstrap-2.2.1.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="ioHub 0.6rc1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>
<div class="container">
  
  <div id="navbar" class="navbar navbar-fixed-top">
    <div class="navbar-inner">
      <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
      <button class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <a class="brand" href="../../index.html">ioHub</a>
      <span class="navbar-text pull-left"><b>0.6rc1</b></span>

      <div class="nav-collapse">
        <ul class="nav">
          <li class="divider-vertical"></li>
          
            <li class="dropdown">
  <a href="../../index.html" class="dropdown-toggle" data-toggle="dropdown">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/api/api_home.html">API Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/api/indices.html">6. API Index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/performance.html">Performance Considerations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/known_issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/change_log.html">Change Log</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../iohub/iohub_license.html">License</a></li>
</ul>
</ul>
</li>
            <li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"></ul>
</li>
          
          
            
          
          
            <li></li>
          
        </ul>

        
          
<form class="navbar-search pull-right" style="margin-bottom:-3px;" action="../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
        
      </div>
    </div>
  </div>

  
  <h1>Source code for ioHub.client</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">ioHub</span>
<span class="sd">.. file: ioHub/client.py</span>

<span class="sd">Copyright (C) 2012 Sol Simpson</span>
<span class="sd">Distributed under the terms of the GNU General Public License (GPL version 3 or any later version).</span>

<span class="sd">.. moduleauthor:: Sol Simpson &lt;sol@isolver-software.com&gt; + contributors, please see credits section of documentation.</span>
<span class="sd">.. fileauthor:: Sol Simpson &lt;sol@isolver-software.com&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">import</span> <span class="nn">struct</span>

<span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">socket</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">psutil</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">load</span>
    <span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">CLoader</span> <span class="k">as</span> <span class="n">Loader</span><span class="p">,</span> <span class="n">CDumper</span> <span class="k">as</span> <span class="n">Dumper</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;*** Using Python based YAML Parsing&quot;</span>
    <span class="kn">from</span> <span class="nn">yaml</span> <span class="kn">import</span> <span class="n">Loader</span><span class="p">,</span> <span class="n">Dumper</span>

<span class="kn">import</span> <span class="nn">ioHub</span>
<span class="kn">from</span> <span class="nn">ioHub</span> <span class="kn">import</span> <span class="n">EventConstants</span>
<span class="kn">from</span> <span class="nn">ioHub.devices</span> <span class="kn">import</span> <span class="n">Computer</span><span class="p">,</span> <span class="n">DeviceEvent</span>
<span class="kn">from</span> <span class="nn">ioHub.devices.experiment</span> <span class="kn">import</span> <span class="n">MessageEvent</span>

<span class="k">if</span> <span class="n">Computer</span><span class="o">.</span><span class="n">system</span><span class="o">==</span><span class="s">&quot;Windows&quot;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">util.experiment</span> <span class="kn">import</span> <span class="n">pumpLocalMessageQueue</span>

<span class="n">MAX_PACKET_SIZE</span><span class="o">=</span><span class="mi">64</span><span class="o">*</span><span class="mi">1024</span>

<span class="n">currentSec</span><span class="o">=</span> <span class="n">Computer</span><span class="o">.</span><span class="n">currentSec</span>

<span class="k">class</span> <span class="nc">ioHubConnectionException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">pack</span> <span class="o">=</span> <span class="bp">None</span>

<span class="k">class</span> <span class="nc">SocketConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">local_host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">local_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">remote_host</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">remote_port</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">rcvBufferLength</span><span class="o">=</span><span class="mi">1492</span><span class="p">,</span> <span class="n">broadcast</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">coder</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_port</span><span class="o">=</span> <span class="n">local_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_local_host</span> <span class="o">=</span> <span class="n">local_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_host</span><span class="o">=</span> <span class="n">remote_host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remote_port</span> <span class="o">=</span> <span class="n">remote_port</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rcvBufferLength</span><span class="o">=</span><span class="n">rcvBufferLength</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastAddress</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initSocket</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">coder</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">=</span><span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">configCoder</span><span class="p">(</span><span class="n">coder</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">initSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">broadcast</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">blocking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="c">#print &#39;Default SocketConnection being used&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">broadcast</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_BROADCAST</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">IPPROTO_IP</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">IP_MULTICAST_TTL</span><span class="p">,</span> <span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="s">&#39;@i&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">blocking</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">settimeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setblocking</span><span class="p">(</span><span class="n">blocking</span><span class="p">)</span>

    <span class="c">#noinspection PyArgumentList</span>
    <span class="k">def</span> <span class="nf">configCoder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">coder</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">pack</span>
        <span class="c">#print &quot;** In configCoder...&quot;, coder</span>
        <span class="k">if</span> <span class="n">coder</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">coder</span> <span class="o">==</span> <span class="s">&#39;ujson&#39;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">ujson</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coder</span><span class="o">=</span><span class="n">ujson</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">encode</span>
                <span class="n">pack</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">encode</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">decode</span>
                <span class="c">#print &#39;ujson:&#39;, self.pack</span>
            <span class="k">elif</span> <span class="n">coder</span> <span class="o">==</span><span class="s">&#39;msgpack&#39;</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">msgpack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">coder</span><span class="o">=</span><span class="n">msgpack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">=</span><span class="n">msgpack</span><span class="o">.</span><span class="n">Packer</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span><span class="o">=</span><span class="n">msgpack</span><span class="o">.</span><span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">pack</span>
                <span class="n">pack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">packer</span><span class="o">.</span><span class="n">pack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unpacker</span><span class="o">.</span><span class="n">unpack</span>
                <span class="c">#print &#39;msgpack:&#39;, self.pack</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span> <span class="p">(</span><span class="s">&quot;Unknown coder type: </span><span class="si">%s</span><span class="s">. Must be either &#39;ujson&#39; or &#39;msgpack&#39;&quot;</span><span class="o">%</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">coder</span><span class="p">),))</span>

    <span class="k">def</span> <span class="nf">sendTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c">#print &#39;DATA [%s] %s %s&#39;%(data,self._remote_host, str(self._remote_port))</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_remote_host</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remote_port</span>
        <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pack</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">byte_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span>
        <span class="c">#print &#39;Sending byte count of &#39;,len(d)+2,type(d)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="s">&#39;</span><span class="se">\r\n</span><span class="s">&#39;</span><span class="p">,</span><span class="n">address</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">byte_count</span>

    <span class="c">#noinspection PyArgumentList</span>
    <span class="k">def</span> <span class="nf">receive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rcvBufferLength</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lastAddress</span><span class="o">=</span><span class="n">address</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">:</span> <span class="c"># using msgpack</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;IOHUB_MULTIPACKET_RESPONSE&#39;</span><span class="p">:</span>
                    <span class="n">num_packets</span><span class="o">=</span><span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">num_packets</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                        <span class="n">data</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rcvBufferLength</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

                    <span class="n">data</span><span class="p">,</span> <span class="n">address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">recvfrom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_rcvBufferLength</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">result</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">,</span><span class="n">address</span>
            <span class="k">else</span><span class="p">:</span>   <span class="c"># using ujson</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]),</span><span class="n">address</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">ioHub</span><span class="o">.</span><span class="n">printExceptionDetailsToStdErr</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="s">&quot; IO_HUB_ERROR &quot;</span><span class="p">,</span> <span class="s">&quot; ioHubConnection socket.receive&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">UDPClientConnection</span><span class="p">(</span><span class="n">SocketConnection</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">remote_host</span><span class="o">=</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span><span class="n">remote_port</span><span class="o">=</span><span class="mi">9000</span><span class="p">,</span><span class="n">rcvBufferLength</span> <span class="o">=</span> <span class="n">MAX_PACKET_SIZE</span><span class="p">,</span><span class="n">broadcast</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="n">blocking</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">coder</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="n">SocketConnection</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">remote_host</span><span class="o">=</span><span class="n">remote_host</span><span class="p">,</span><span class="n">remote_port</span><span class="o">=</span><span class="n">remote_port</span><span class="p">,</span><span class="n">rcvBufferLength</span><span class="o">=</span><span class="n">rcvBufferLength</span><span class="p">,</span><span class="n">broadcast</span><span class="o">=</span><span class="n">broadcast</span><span class="p">,</span><span class="n">blocking</span><span class="o">=</span><span class="n">blocking</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span><span class="n">coder</span><span class="o">=</span><span class="n">coder</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initSocket</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c">#print &#39;UDPClientConnection being used&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_DGRAM</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sock</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_RCVBUF</span><span class="p">,</span> <span class="n">MAX_PACKET_SIZE</span><span class="p">)</span>

<span class="c">#</span>
<span class="c"># The ioHubDeviceView is the ioHub client side representation of an ioHub device.</span>
<span class="c"># It has a dynamically created list of methods that can be called</span>
<span class="c"># (matching the list of methods for the device in the ioHub.devices module),</span>
<span class="c"># however here, each results in an RPC call to the ioHub for the device, which returns</span>
<span class="c"># the result.</span>
<span class="c">#</span>
<span class="k">class</span> <span class="nc">DeviceRPC</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sendToHub</span><span class="p">,</span><span class="n">device_class</span><span class="p">,</span><span class="n">method_name</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_class</span><span class="o">=</span><span class="n">device_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="o">=</span><span class="n">method_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToHub</span><span class="o">=</span><span class="n">sendToHub</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendToHub</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;DEV_RPC&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device_class</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">method_name</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="n">kwargs</span><span class="p">))</span>
        <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">r</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">r</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">method_name</span> <span class="o">==</span> <span class="s">&#39;getEvents&#39;</span><span class="p">:</span>
            <span class="n">asType</span><span class="o">=</span><span class="s">&#39;namedtuple&#39;</span>
            <span class="k">if</span> <span class="s">&#39;asType&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">asType</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;asType&#39;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conversionMethod</span><span class="o">=</span><span class="bp">None</span>
                <span class="k">if</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;dict&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="n">ioHubConnection</span><span class="o">.</span><span class="n">_eventListToDict</span>
                <span class="k">elif</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="n">ioHubConnection</span><span class="o">.</span><span class="n">_eventListToObject</span>
                <span class="k">elif</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;namedtuple&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="n">ioHubConnection</span><span class="o">.</span><span class="n">_eventListToNamedTuple</span>

                <span class="k">if</span> <span class="n">conversionMethod</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">conversionMethod</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">r</span>

<span class="k">class</span> <span class="nc">ioHubDeviceView</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ioHubDeviceView is used by the ioHubConnection class to create a PsychoPy Process side representation</span>
<span class="sd">    of each ioHub Server Process device that has been defined in the ioHub configuration file for the</span>
<span class="sd">    current experiment. You never create instances of this class directly; they are created for you by the</span>
<span class="sd">    ioHubConnection class when it connects to the ioHub Process.</span>

<span class="sd">    The ioHubDeviceView provides methods to access the device name, instanceCode, and , associated</span>
<span class="sd">    ioHub Device Class.</span>

<span class="sd">    When the ioHubConnection class instance is created for your experiment, each device defined in</span>
<span class="sd">    the ioHub configuration file has a ioHub.devices.Device object created on the ioHub Server process,</span>
<span class="sd">    as well as a ioHubDeviceView object created on the PsychoPy Process that can be accessed from your</span>
<span class="sd">    experiment script.</span>

<span class="sd">    The ioHubConnection.devices attribute provides access to each ioHubDeviceView object that has been created</span>
<span class="sd">    via an attribute that has the same name as the name provided for the device in the ioHub configuration file.</span>

<span class="sd">    For example, if the ioHub configuration file for an experiment contains a keyboard and mouse device like:</span>

<span class="sd">    # start .yaml file snippet</span>

<span class="sd">    - device:</span>
<span class="sd">        device_class: Keyboard</span>
<span class="sd">        name: kb</span>
<span class="sd">        saveEvents: True</span>
<span class="sd">        streamEvents: True</span>
<span class="sd">        event_buffer_length: 256</span>
<span class="sd">    - device:</span>
<span class="sd">        device_class: Mouse</span>
<span class="sd">        name: mouse</span>
<span class="sd">        saveEvents: True</span>
<span class="sd">        streamEvents: True</span>
<span class="sd">        event_buffer_length: 256</span>

<span class="sd">    # end .yaml file snippet</span>

<span class="sd">    then two ioHubDeviceView objects will be created, one called &#39;kb&#39; for the Keyboard Device, and a second called</span>
<span class="sd">    &#39;mouse&#39; for the Mouse Device.</span>

<span class="sd">    These can be accessed via:</span>

<span class="sd">        experimentKeyboard = ioHubConnectionInstance.devices.kb</span>
<span class="sd">        experimentMouse = ioHubConnectionInstance.devices.mouse</span>

<span class="sd">    If your PsychoPy script is running in a class that extends ioHub.experiment.ioHubExperimentRuntime, the</span>
<span class="sd">    devices can be accessed via:</span>

<span class="sd">         experimentKeyboard = self.hub.devices.kb</span>
<span class="sd">         experimentMouse = self.hub.devices.mouse</span>


<span class="sd">    Each ioHubDeviceView that is created when the ioHubConnection has connected to the ioHub Process, queries</span>
<span class="sd">    the ioHub Process for the current list of public method names for the given device_class. This list of names,</span>
<span class="sd">    which can be accessed by calling,</span>

<span class="sd">        methodNameList=ioHubDeviceViewInstance.getDeviceInterface()</span>

<span class="sd">    is used to provide the PsychoPy Process interface to the given device type. This allows a PsychoPy / ioHub</span>
<span class="sd">    experiment to call device methods on the ioHub Process as if the device method calls were being made locally.</span>

<span class="sd">    For example, to access a list of new keyboard events from the keyboard device, assuming you are running within a</span>
<span class="sd">    class that extends ioHub.experiment.ioHubExperimentRuntime, you would use the following code:</span>

<span class="sd">        kb = self.hub.devices.kb</span>
<span class="sd">        kb_events=kb.getEvents()</span>

<span class="sd">        print &#39;Keyboard Events&#39;, kb_events</span>

<span class="sd">    To set the current position of the system mouse cursor to be screen center, you could write the following:</span>

<span class="sd">        mouse = self.hub.devices.mouse</span>
<span class="sd">        print &#39;Mouse Position Before Update:&#39;, mouse.getPosition()</span>
<span class="sd">        mouse.setPosition((0,0))</span>
<span class="sd">        print &#39;Mouse Position After Update to (0,0):&#39;, mouse.getPosition()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hubClient</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">dclass</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hubClient</span><span class="o">=</span><span class="n">hubClient</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_class</span><span class="o">=</span><span class="n">dclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preRemoteMethodCallFunctions</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postRemoteMethodCallFunctions</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>

        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hubClient</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;GET_DEV_INTERFACE&#39;</span><span class="p">,</span><span class="n">dclass</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_preRemoteMethodCallFunctions</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span><span class="n">ka</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_preRemoteMethodCallFunctions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">f</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">DeviceRPC</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hubClient</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">device_class</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_postRemoteMethodCallFunctions</span><span class="p">:</span>
                <span class="n">f</span><span class="p">,</span><span class="n">ka</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_postRemoteMethodCallFunctions</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="n">f</span><span class="p">(</span><span class="n">ka</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r</span>
        <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setPreRemoteMethodCallFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">methodName</span><span class="p">,</span><span class="n">functionCall</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_preRemoteMethodCallFunctions</span><span class="p">[</span><span class="n">methodName</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">functionCall</span><span class="p">,</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setPostRemoteMethodCallFunction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">methodName</span><span class="p">,</span><span class="n">functionCall</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_postRemoteMethodCallFunctions</span><span class="p">[</span><span class="n">methodName</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">functionCall</span><span class="p">,</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">getName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the name given to the device in the ioHub configuration file.</span>
<span class="sd">        ( the device: name: property )</span>

<span class="sd">        Args: None</span>
<span class="sd">        Return (str): the user defined label / name of the device</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">def</span> <span class="nf">getIOHubDeviceClass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the ioHub Server Device class given associated with the ioHubDeviceView.</span>
<span class="sd">        This is specified for a device in the ioHub configuration file.</span>
<span class="sd">        ( the device: device_class: property )</span>

<span class="sd">        Args: None</span>
<span class="sd">        Return (class): the ioHub Server Device class associated with this ioHubDeviceView</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_class</span>

    <span class="k">def</span> <span class="nf">getDeviceInterface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        getDeviceInterface returns a list containing the names of all methods that are callable</span>
<span class="sd">        for the ioHubDeviceView object. Only public methods are considered to be valid members of</span>
<span class="sd">        the devices interface. (so any method beginning with a &#39;_&#39; is not included.</span>

<span class="sd">        Args: None</span>

<span class="sd">        Return (tuple): the list of method names that make up the ioHubDeviceView interface.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_methods</span>


<span class="k">class</span> <span class="nc">ioHubDevices</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ioHubDevices is a class that contains an attribute (dynamically created) for each device that is created in the ioHub.</span>
<span class="sd">    These devices are each of type ioHubDeviceView. The attribute name for the device is the user name given to</span>
<span class="sd">    the device by the user in the ioHub config file label: field, so it must be a valid python attribute name.</span>

<span class="sd">    Each ioHubDeviceView itself has a list of methods that can be called (matching the list of public methods for the</span>
<span class="sd">    device in the ioHub.devices module), however here, each results in an IPC call to the ioHub Server for the device,</span>
<span class="sd">    which returns the result to the experiment process.</span>

<span class="sd">    A user never uses this class directly, it is used internallby by the ioHubVlient class to dynamically build out</span>
<span class="sd">    the experiment process side representation of the ioHub Server device set.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">hubClient</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hubClient</span><span class="o">=</span><span class="n">hubClient</span>

<div class="viewcode-block" id="ioHubConnection"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection">[docs]</a><span class="k">class</span> <span class="nc">ioHubConnection</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ioHubConnection is the Experiment Process side class that is responsible for </span>
<span class="sd">    communicating with the ioHub Process. ioHubConnection is responsible for for creating</span>
<span class="sd">    the ioHub Server Process, sending requests to the ioHub Server Process, and reading</span>
<span class="sd">    the ioHub Server Process reply. This class can also tell the ioHub server when to</span>
<span class="sd">    close down and disconnect.</span>
<span class="sd">    </span>
<span class="sd">    The ioHubConnection class is also used to access ioHub devices from the PsychoPy</span>
<span class="sd">    experiment runtime script. These device objects can be accessed via the ioHubConnection&#39;s</span>
<span class="sd">    *deviceByLabel* dictionary attribute. For example, to print the available methods for each device registered with the ioHub Server,</span>
<span class="sd">    assuming *hub* refers to the ioHubConnection instance *or* an instance of the ioHubExperimentRuntime</span>
<span class="sd">    class (in which case *hub* would likely be replaced with *self.hub*):</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; for device_name,device_access in hub.deviceByLabel.iteritems():</span>
<span class="sd">        &gt;&gt;&gt;    print &#39;Device Name: &#39;,device_name</span>
<span class="sd">        &gt;&gt;&gt;    print &#39;Device Interface:&#39;</span>
<span class="sd">        &gt;&gt;&gt;    for method in device_access.getDeviceInterface():</span>
<span class="sd">        &gt;&gt;&gt;        print &#39;\t&#39;,method</span>
<span class="sd">        &gt;&gt;&gt;    print &quot;--------------&quot;              </span>
<span class="sd">        Device Name:  kb</span>
<span class="sd">        Device Interface:</span>
<span class="sd">            DeviceConstants</span>
<span class="sd">            clearEvents</span>
<span class="sd">            enableEventReporting</span>
<span class="sd">            getEvents</span>
<span class="sd">            getStartupConfiguration</span>
<span class="sd">            isReportingEvents</span>
<span class="sd">        --------------</span>
<span class="sd">        Device Name:  mouse</span>
<span class="sd">        Device Interface:</span>
<span class="sd">            DeviceConstants</span>
<span class="sd">            clearEvents</span>
<span class="sd">            enableEventReporting</span>
<span class="sd">            getCurrentButtonStates</span>
<span class="sd">            getEvents</span>
<span class="sd">            getPosition</span>
<span class="sd">            getPositionAndDelta</span>
<span class="sd">            getStartupConfiguration</span>
<span class="sd">            getSystemCursorVisibility</span>
<span class="sd">            getVerticalScroll</span>
<span class="sd">            isReportingEvents</span>
<span class="sd">            setPosition</span>
<span class="sd">            setSystemCursorVisibility</span>
<span class="sd">            setVerticalScroll</span>
<span class="sd">        --------------</span>
<span class="sd">        Device Name:  display</span>
<span class="sd">        Device Interface:</span>
<span class="sd">            DeviceConstants</span>
<span class="sd">            clearEvents</span>
<span class="sd">            displayCoord2Pixel</span>
<span class="sd">            enableEventReporting</span>
<span class="sd">            getConfigFileDistance</span>
<span class="sd">            getConfigFileHeight</span>
<span class="sd">            getConfigFileWidth</span>
<span class="sd">            getDisplayCoordinateType</span>
<span class="sd">            getEvents</span>
<span class="sd">            getMonitorCount</span>
<span class="sd">            getPPD</span>
<span class="sd">            getPsychoPyMonitorSettingsName</span>
<span class="sd">            getScreenInfoList</span>
<span class="sd">            getStartupConfiguration</span>
<span class="sd">            getStimulusScreenBounds</span>
<span class="sd">            getStimulusScreenIndex</span>
<span class="sd">            getStimulusScreenInfo</span>
<span class="sd">            getStimulusScreenOrigin</span>
<span class="sd">            getStimulusScreenReportedRetraceInterval</span>
<span class="sd">            getStimulusScreenResolution</span>
<span class="sd">            isReportingEvents</span>
<span class="sd">            pixel2DisplayCoord</span>
<span class="sd">            setStimulusScreenIndex</span>
<span class="sd">        --------------</span>
<span class="sd">        Device Name:  experimentRuntime</span>
<span class="sd">        Device Interface:</span>
<span class="sd">            DeviceConstants</span>
<span class="sd">            clearEvents</span>
<span class="sd">            enableEventReporting</span>
<span class="sd">            getEvents</span>
<span class="sd">            getStartupConfiguration</span>
<span class="sd">            isReportingEvents</span>
<span class="sd">        --------------</span>
<span class="sd">    </span>
<span class="sd">    If you know the name of the device that you want to access (it is the *name* </span>
<span class="sd">    specified for the device in the iohub_config.yaml settings file) then the device can</span>
<span class="sd">    simply be accesed via the *devices* attribute of either the ioHubConnection or </span>
<span class="sd">    ioHubExperimentRuntime classes:</span>
<span class="sd">    </span>
<span class="sd">        &gt;&gt;&gt; # get the Mouse device, named mouse</span>
<span class="sd">        &gt;&gt;&gt; mouse=hub.devices.mouse</span>
<span class="sd">        &gt;&gt;&gt; current_mouse_position = mouse.getPosition()</span>
<span class="sd">        &gt;&gt;&gt; print &#39;current mouse position: &#39;, current_mouse_position        </span>
<span class="sd">        current mouse position:  [-211.0, 371.0]</span>
<span class="sd">        </span>
<span class="sd">        &gt;&gt;&gt; # get any keyboard events from the keyboard device</span>
<span class="sd">        &gt;&gt;&gt; kb=hub.devices.keyboard</span>
<span class="sd">        &gt;&gt;&gt; # wait 1 second. While waiting, gets events from ioHub Server and buffers </span>
<span class="sd">        &gt;&gt;&gt; #    them locally at an interval that can be set using the checkHubInterval</span>
<span class="sd">        &gt;&gt;&gt; #    kwarg, which is set to 0.02 seconds (20 msec) by default.</span>

<span class="sd">        &gt;&gt;&gt; hub.delay(1.0)</span>
<span class="sd">        &gt;&gt;&gt; events = kb.getEvents()</span>
<span class="sd">        &gt;&gt;&gt; for kb_event in events:</span>
<span class="sd">        &gt;&gt;&gt;    print &#39;kb_event: &#39;, kb_event        </span>
<span class="sd">        kb_event:  KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=71, type=21, device_time=423231.18, logged_time=3.2645300622680224, time=3.2645300622680224, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=44, ascii_code=122, key_id=90, key=&#39;z&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardReleaseEventNT(experiment_id=0, session_id=0, event_id=72, type=22, device_time=423231.242, logged_time=3.3285222236299887, time=3.3285222236299887, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=44, ascii_code=122, key_id=90, key=&#39;z&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardCharEventNT(experiment_id=0, session_id=0, event_id=73, type=23, device_time=423231.242, logged_time=3.3285222236299887, time=3.3285222236299887, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=44, ascii_code=122, key_id=90, key=&#39;z&#39;, modifiers=None, window_id=5310920, pressEvent=KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=71, type=21, device_time=423231.18, logged_time=3.2645300622680224, time=3.2645300622680224, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=44, ascii_code=122, key_id=90, key=&#39;z&#39;, modifiers=None, window_id=5310920), duration=0.06399216136196628)        </span>
<span class="sd">        kb_event:  KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=86, type=21, device_time=423231.866, logged_time=3.9525340902619064, time=3.9525340902619064, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=45, ascii_code=120, key_id=88, key=&#39;x&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardReleaseEventNT(experiment_id=0, session_id=0, event_id=87, type=22, device_time=423231.944, logged_time=4.032557043596171, time=4.032557043596171, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=45, ascii_code=120, key_id=88, key=&#39;x&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardCharEventNT(experiment_id=0, session_id=0, event_id=88, type=23, device_time=423231.944, logged_time=4.032557043596171, time=4.032557043596171, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=45, ascii_code=120, key_id=88, key=&#39;x&#39;, modifiers=None, window_id=5310920, pressEvent=KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=86, type=21, device_time=423231.866, logged_time=3.9525340902619064, time=3.9525340902619064, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=45, ascii_code=120, key_id=88, key=&#39;x&#39;, modifiers=None, window_id=5310920), duration=0.08002295333426446)        </span>
<span class="sd">        kb_event:  KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=92, type=21, device_time=423232.272, logged_time=4.352586070308462, time=4.352586070308462, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=32, ascii_code=100, key_id=68, key=&#39;d&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardReleaseEventNT(experiment_id=0, session_id=0, event_id=93, type=22, device_time=423232.35, logged_time=4.432587591640186, time=4.432587591640186, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=32, ascii_code=100, key_id=68, key=&#39;d&#39;, modifiers=None, window_id=5310920)        </span>
<span class="sd">        kb_event:  KeyboardCharEventNT(experiment_id=0, session_id=0, event_id=94, type=23, device_time=423232.35, logged_time=4.432587591640186, time=4.432587591640186, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=32, ascii_code=100, key_id=68, key=&#39;d&#39;, modifiers=None, window_id=5310920, pressEvent=KeyboardPressEventNT(experiment_id=0, session_id=0, event_id=92, type=21, device_time=423232.272, logged_time=4.352586070308462, time=4.352586070308462, confidence_interval=0.0, delay=0.0, filter_id=0, scan_code=32, ascii_code=100, key_id=68, key=&#39;d&#39;, modifiers=None, window_id=5310920), duration=0.08000152133172378)</span>
<span class="sd">        ioHub Server Process Completed With Code:  0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_replyDictionary</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ioHubConfig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">ioHubConfigAbsPath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initial_clock_offset</span><span class="o">=</span><span class="n">ioHub</span><span class="o">.</span><span class="n">highPrecisionTimer</span><span class="p">()</span>
        <span class="n">Computer</span><span class="o">.</span><span class="n">globalClock</span><span class="o">=</span><span class="n">ioHub</span><span class="o">.</span><span class="n">ioClock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_clock_offset</span><span class="p">,</span><span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ioHubConfig</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ioHubConfig</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ioHub</span><span class="o">.</span><span class="n">ioHubError</span><span class="p">(</span><span class="s">&quot;The provided ioHub Configuration is not a dictionary.&quot;</span><span class="p">,</span> <span class="n">ioHubConfig</span><span class="p">)</span>
            
        <span class="c"># udp port setup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="c"># the dynamically generated object that contains an attribute for</span>
        <span class="c"># each device registed for monitoring with the ioHub server so</span>
        <span class="c"># that devices can be accessed experiment process side by device name.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="o">=</span><span class="n">ioHubDevices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># a dictionary that holds the same devices represented in .devices, </span>
        <span class="c"># but stored in a dictionary using the device</span>
        <span class="c"># name as the dictionary key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="o">=</span><span class="nb">dict</span><span class="p">()</span>
        
        
        <span class="c"># A circular buffer used to hold events retrieved from self.getEvents() during </span>
        <span class="c"># self.delay() calls. self.getEvents() appends any events in the allEvents</span>
        <span class="c"># buffer to the result of the hub.getEvents() call that is made.  </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span><span class="o">=</span><span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>

        <span class="c"># attribute to hold the current experiment ID that has been </span>
        <span class="c"># created by the ioHub ioDataStore if saving data to the</span>
        <span class="c"># ioHub hdf5 file type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experimentID</span><span class="o">=</span><span class="bp">None</span>

        <span class="c"># attribute to hold the current experiment session ID that has been</span>
        <span class="c"># created by the ioHub ioDataStore if saving data to the</span>
        <span class="c"># ioHub hdf5 file type.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experimentSessionID</span><span class="o">=</span><span class="bp">None</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">_startServer</span><span class="p">(</span><span class="n">ioHubConfig</span><span class="p">,</span> <span class="n">ioHubConfigAbsPath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_startServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ioHubConfig</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ioHubConfigAbsPath</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts the ioHub Server Process, storing it&#39;s process id, and creating the experiment side device representation</span>
<span class="sd">        for IPC access to public device methods.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">experiment_info</span><span class="o">=</span><span class="bp">None</span>
        <span class="n">session_info</span><span class="o">=</span><span class="bp">None</span>
        
        <span class="n">rootScriptPath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">ioHubConfigAbsPath</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ioHubConfig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ioHubConfig</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">monitor_devices</span><span class="o">=</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">Keyboard</span><span class="o">=</span><span class="p">{}),</span><span class="nb">dict</span><span class="p">(</span><span class="n">Display</span><span class="o">=</span><span class="p">{}),</span><span class="nb">dict</span><span class="p">(</span><span class="n">Mouse</span><span class="o">=</span><span class="p">{})])</span>
        <span class="k">elif</span> <span class="n">ioHubConfig</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ioHubConfigAbsPath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;monitor_devices&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ioHubConfig</span><span class="p">:</span>
                <span class="n">ioHub</span><span class="o">.</span><span class="n">print2err</span><span class="p">(</span><span class="s">&quot;ERROR: ioHubConfig must be provided with &#39;monitor_devices&#39; key.&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="s">&#39;ioDataStore&#39;</span> <span class="ow">in</span> <span class="n">ioHubConfig</span><span class="p">:</span>
                <span class="n">iods</span><span class="o">=</span><span class="n">ioHubConfig</span><span class="p">[</span><span class="s">&#39;ioDataStore&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="s">&#39;experiment_info&#39;</span> <span class="ow">in</span> <span class="n">iods</span> <span class="ow">and</span> <span class="s">&#39;session_info&#39;</span> <span class="ow">in</span> <span class="n">iods</span><span class="p">:</span>
                    <span class="n">experiment_info</span><span class="o">=</span><span class="n">iods</span><span class="p">[</span><span class="s">&#39;experiment_info&#39;</span><span class="p">]</span>
                    <span class="n">session_info</span><span class="o">=</span><span class="n">iods</span><span class="p">[</span><span class="s">&#39;session_info&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">ioHubConfig</span><span class="p">[</span><span class="s">&#39;ioDataStore&#39;</span><span class="p">][</span><span class="s">&#39;experiment_info&#39;</span><span class="p">]</span>
                    <span class="k">del</span> <span class="n">ioHubConfig</span><span class="p">[</span><span class="s">&#39;ioDataStore&#39;</span><span class="p">][</span><span class="s">&#39;session_info&#39;</span><span class="p">]</span>
                    
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ioHub</span><span class="o">.</span><span class="n">print2err</span><span class="p">(</span><span class="s">&quot;ERROR: ioHubConfig:ioDataStore must contain both a &#39;experiment_info&#39; and a &#39;session_info&#39; key with a dict value each.&quot;</span><span class="p">)</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>   
                    
        <span class="k">elif</span> <span class="n">ioHubConfigAbsPath</span>  <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">ioHubConfig</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">ioHubConfig</span><span class="o">=</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">(</span><span class="n">ioHubConfigAbsPath</span><span class="p">,</span><span class="s">u&#39;r&#39;</span><span class="p">),</span> <span class="n">Loader</span><span class="o">=</span><span class="n">Loader</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">=</span><span class="n">UDPClientConnection</span><span class="p">(</span><span class="n">coder</span><span class="o">=</span><span class="n">ioHubConfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ipcCoder&#39;</span><span class="p">,</span><span class="s">&#39;msgpack&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>        
            <span class="n">ioHub</span><span class="o">.</span><span class="n">print2err</span><span class="p">(</span><span class="s">&quot;ERROR: Both a ioHubConfig dict object AND a path to an ioHubConfig file can not be provided.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ioHubConfig</span> <span class="ow">and</span> <span class="n">ioHubConfigAbsPath</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>                
                    <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">=</span><span class="n">UDPClientConnection</span><span class="p">(</span><span class="n">coder</span><span class="o">=</span><span class="n">ioHubConfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ipcCoder&#39;</span><span class="p">,</span><span class="s">&#39;msgpack&#39;</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ioHubConfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;monitor_devices&#39;</span><span class="p">),</span><span class="nb">dict</span><span class="p">):</span>
                    <span class="c">#short hand device spec is being used. Convert dict of </span>
                    <span class="c">#devices in a list of device dicts.</span>
                    <span class="n">devs</span><span class="o">=</span><span class="n">ioHubConfig</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;monitor_devices&#39;</span><span class="p">)</span>
                    <span class="n">devsList</span><span class="o">=</span><span class="p">[{</span><span class="n">dname</span><span class="p">:</span><span class="n">dc</span><span class="p">}</span> <span class="k">for</span> <span class="n">dname</span><span class="p">,</span><span class="n">dc</span> <span class="ow">in</span> <span class="n">devs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
                    <span class="n">ioHubConfig</span><span class="p">[</span><span class="s">&#39;monitor_devices&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">devsList</span>
                        
                <span class="kn">import</span> <span class="nn">tempfile</span>
                <span class="n">tfile</span><span class="o">=</span><span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s">&#39;w&#39;</span><span class="p">,</span><span class="n">suffix</span><span class="o">=</span><span class="s">&#39;iohub&#39;</span><span class="p">,</span><span class="n">delete</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">tfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pack</span><span class="p">(</span><span class="n">ioHubConfig</span><span class="p">))</span>
                <span class="n">ioHubConfigAbsPath</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">tfile</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>               
                <span class="n">tfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="n">run_script</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ioHub</span><span class="o">.</span><span class="n">IO_HUB_DIRECTORY</span><span class="p">,</span><span class="s">&#39;server.py&#39;</span><span class="p">)</span>
        <span class="n">subprocessArgList</span><span class="o">=</span><span class="p">[</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="p">,</span> <span class="n">run_script</span><span class="p">,</span><span class="s">&quot;</span><span class="si">%.6f</span><span class="s">&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_initial_clock_offset</span><span class="p">,),</span><span class="n">rootScriptPath</span><span class="p">,</span><span class="n">ioHubConfigAbsPath</span><span class="p">]</span>


        <span class="c"># check for existing ioHub Process based on process if saved to file</span>
        <span class="n">iopFileName</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ioHub</span><span class="o">.</span><span class="n">IO_HUB_DIRECTORY</span><span class="p">,</span><span class="s">&#39;.iohpid&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">iopFileName</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">iopFile</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">iopFileName</span><span class="p">,</span><span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">line</span><span class="o">=</span><span class="n">iopFile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                <span class="n">iopFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">iopFileName</span><span class="p">)</span>
                <span class="n">other</span><span class="p">,</span><span class="n">iohub_pid</span><span class="o">=</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span>
                <span class="n">iohub_pid</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">iohub_pid</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="n">old_iohub_process</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">iohub_pid</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">old_iohub_process</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;python.exe&#39;</span><span class="p">:</span>
                    <span class="n">old_iohub_process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">NoSuchProcess</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ioHub</span><span class="o">.</span><span class="n">printExceptionDetailsToStdErr</span><span class="p">()</span>

        <span class="c">#print &#39;STARTING IOSERVER.....&#39;</span>
        <span class="c"># start subprocess, get pid, and get psutil process object for affinity and process priority setting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">subprocessArgList</span><span class="p">,</span><span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcessID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span><span class="o">.</span><span class="n">pid</span>
        <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="o">=</span><span class="n">psutil</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcessID</span><span class="p">)</span>

        <span class="c"># wait for server to send back &#39;IOHUB_READY&#39; text over stdout, indicating it is running</span>
        <span class="c"># and ready to receive network packets</span>
        <span class="n">hubonline</span><span class="o">=</span><span class="bp">False</span>
        <span class="n">server_output</span><span class="o">=</span><span class="s">&#39;hi there&#39;</span>
        <span class="n">ctime</span> <span class="o">=</span> <span class="n">Computer</span><span class="o">.</span><span class="n">globalClock</span><span class="o">.</span><span class="n">getTime</span>
        <span class="n">timeout_time</span><span class="o">=</span><span class="n">ctime</span><span class="p">()</span><span class="o">+</span><span class="mf">10.0</span> <span class="c"># timeout if ioServer does not reply in 10 seconds</span>
        <span class="k">while</span> <span class="n">server_output</span> <span class="ow">and</span> <span class="n">ctime</span><span class="p">()</span><span class="o">&lt;</span><span class="n">timeout_time</span><span class="p">:</span>
            <span class="n">isDataAvail</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_serverStdOutHasData</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">isDataAvail</span> <span class="ow">is</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">server_output</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_readServerStdOutLine</span><span class="p">()</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">server_output</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;IOHUB_READY&#39;</span><span class="p">:</span>
                    <span class="n">hubonline</span><span class="o">=</span><span class="bp">True</span>
                    <span class="c">#print &quot;Ending Serving connection attempt due to timeout....&quot;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">)</span>
                
        <span class="c"># If ioHub server did not repond correctly, terminate process and exit the program.</span>
        <span class="k">if</span> <span class="n">hubonline</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;ioHub could not be contacted, exiting....&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c"># save ioHub ProcessID to file so next time it is started, it can be checked and killed if necessary</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">iopFile</span><span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">iopFileName</span><span class="p">,</span><span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">iopFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;ioHub PID: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcessID</span><span class="p">))</span>
            <span class="n">iopFile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="n">iopFile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ioHub</span><span class="o">.</span><span class="n">printExceptionDetailsToStdErr</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">experiment_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendExperimentInfo</span><span class="p">(</span><span class="n">experiment_info</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">session_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sendSessionInfo</span><span class="p">(</span><span class="n">session_info</span><span class="p">)</span>
        <span class="c"># create a local &#39;thin&#39; representation of the registered ioHub devices,</span>
        <span class="c"># allowing such things as device level event access (if supported) </span>
        <span class="c"># and transparent IPC calls of public device methods and return value access.</span>
        <span class="c"># Devices are available as hub.devices.[device_name] , where device_name</span>
        <span class="c"># is the name given to the device in the ioHub .yaml config file to be access;</span>
        <span class="c"># i.e. hub.devices.ExperimentPCkeyboard would access the experiment PC keyboard</span>
        <span class="c"># device if the default name was being used.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_createDeviceList</span><span class="p">()</span>
                    
    <span class="k">def</span> <span class="nf">_get_maxsize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used by _startServer pipe reader code.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">maxsize</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">1024</span>
        <span class="k">elif</span> <span class="n">maxsize</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">maxsize</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">maxsize</span>


    <span class="k">def</span> <span class="nf">_serverStdOutHasData</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxsize</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used by _startServer pipe reader code. Allows for async check for data on pipe in windows.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">Computer</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="s">&#39;Windows&#39;</span><span class="p">:</span>        
            <span class="c">#  &gt;&gt; WIN32_ONLY</span>
            <span class="kn">import</span> <span class="nn">msvcrt</span>
            <span class="kn">from</span> <span class="nn">win32pipe</span> <span class="kn">import</span> <span class="n">PeekNamedPipe</span>
    
            <span class="n">maxsize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_maxsize</span><span class="p">(</span><span class="n">maxsize</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span><span class="o">.</span><span class="n">stdout</span>
    
            <span class="k">if</span> <span class="n">conn</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">msvcrt</span><span class="o">.</span><span class="n">get_osfhandle</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">fileno</span><span class="p">())</span>
                <span class="p">(</span><span class="n">read</span><span class="p">,</span> <span class="n">nAvail</span><span class="p">,</span> <span class="n">nMessage</span><span class="p">)</span> <span class="o">=</span> <span class="n">PeekNamedPipe</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">maxsize</span> <span class="o">&lt;</span> <span class="n">nAvail</span><span class="p">:</span>
                    <span class="n">nAvail</span> <span class="o">=</span> <span class="n">maxsize</span>
                <span class="k">if</span> <span class="n">nAvail</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">True</span>
            <span class="c"># &lt;&lt; WIN32_ONLY</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Computer</span><span class="o">.</span><span class="n">system</span> <span class="o">==</span> <span class="s">&#39;Linux&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
            
    <span class="k">def</span> <span class="nf">_readServerStdOutLine</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Used by _startServer pipe reader code. Reads a line from the ioHub server stdout. This is blocking.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">line</span>

    <span class="k">def</span> <span class="nf">_calculateClientServerTimeOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sampleSize</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates &#39;sampleSize&#39; experimentTime and ioHub Server time process offsets by calling currentSec locally</span>
<span class="sd">        and via IPC to the ioHub server process repeatedly, as ewell as calculating the round trip time it took to get the server process time in each case.</span>
<span class="sd">        Puts the &#39;sampleSize&#39; calculates in a 2D numpy array, index [i][0] = server_time - local_time offset, index [i][1]</span>
<span class="sd">        = local_time after call to server_time - local_time before call to server_time.</span>

<span class="sd">        In Windows, since direct QPC implementation is used, offset should == delay to within 100 usec or so.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">sampleSize</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="s">&#39;f4&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="n">sampleSize</span><span class="p">):</span>     <span class="c"># make multiple calles to local and ioHub times to calculate &#39;offset&#39; and &#39;delay&#39; in calling the ioHub server time</span>
            <span class="n">tc</span><span class="o">=</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentSec</span><span class="p">()</span><span class="o">*</span><span class="mf">1000.0</span>   <span class="c"># get the local time 1</span>
            <span class="n">ts</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">currentSec</span><span class="p">()</span><span class="o">*</span><span class="mf">1000.0</span>        <span class="c"># get the ioHub server time (this results in a RPC call and response from the server)</span>
            <span class="n">tc2</span><span class="o">=</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentSec</span><span class="p">()</span><span class="o">*</span><span class="mf">1000.0</span>   <span class="c"># get local time 2, to calculate e2e delay for the ioHub server time call</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">ts</span><span class="o">-</span><span class="n">tc</span>          <span class="c"># calculate time difference between returned iohub server time, and 1 read local time (offset)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tc2</span><span class="o">-</span><span class="n">tc</span>         <span class="c"># calculate delay / duration it took to make the call to the ioHub server and get reply</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>            <span class="c"># sleep for a little before going next loop</span>
        <span class="c">#print N.min(results,axis=0) ,N.max(results,axis=0) , N.average(results,axis=0), N.std(results,axis=0)</span>
        <span class="k">return</span> <span class="n">results</span>

    <span class="k">def</span> <span class="nf">_createDeviceList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Populate the devices attribute object with the registered devices of the ioHub. Each ioHub device becomes an attribute</span>
<span class="sd">        of the devices instance, with the attribute name == the name give the device in the ioHub configuration file.</span>
<span class="sd">        Each device in allows access to the pupic method interface of the device via transparent IPC calls to the ioHub server process</span>
<span class="sd">        from the expriment process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get the list of devices registered with the ioHub</span>
        <span class="n">deviceList</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getDeviceList</span><span class="p">()</span>

        <span class="c"># create an experiment process side device object to allow access to the public interface of the</span>
        <span class="c"># ioHub device via transparent IPC.</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span><span class="n">device_class</span> <span class="ow">in</span> <span class="n">deviceList</span><span class="p">:</span>
            <span class="n">d</span><span class="o">=</span><span class="n">ioHubDeviceView</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">device_class</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">devices</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">=</span><span class="n">d</span>

    <span class="c"># UDP communication with ioHost</span>
<div class="viewcode-block" id="ioHubConnection.sendToHubServer"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.sendToHubServer">[docs]</a>    <span class="k">def</span> <span class="nf">sendToHubServer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">ioHubMessage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General purpose message sending routine,  used to send a message from the PsychoPy Process</span>
<span class="sd">        to the ioHub Process, and then wait for the reply from the ioHub Process before returning.</span>

<span class="sd">        The ioHub Server accepts data send either encoded using the [msgpack](https://github.com/msgpack/msgpack-python)</span>
<span class="sd">        library or json encoded using the [ujson](https://github.com/esnme/ultrajson) library</span>
<span class="sd">        ( it is **fast** ).</span>

<span class="sd">        Which encoding type is used is specified in the ioHub configuration file by the ipcCoder: parameter.</span>
<span class="sd">        By default *msgpack* is selected, as it seems to be as fast as ujson, but it also compresses</span>
<span class="sd">        event data by up to 40 - 50% for transmission.</span>

<span class="sd">        All messages sent to the ioHub (a.k.a the ioHubMessage param) have the following simple format:</span>

<span class="sd">        (msg_type, [callable_name_for_IPC], ( [optional_list_of_args], {optional_dict_of_kw_args} ) )</span>

<span class="sd">        The currently supported message types are:</span>

<span class="sd">        #. RPC</span>
<span class="sd">        #. GET_EVENTS</span>
<span class="sd">        #. EXP_DEVICE</span>

<span class="sd">        Every request to the ioHub Server Process is sent a response / reply back, even if it</span>
<span class="sd">        is just to indicate the request was receive and if it was processed successfully or not. All</span>
<span class="sd">        responses from the ioHub server are in the form:</span>

<span class="sd">        (response_type, *response_values)</span>

<span class="sd">        where *response_values is a list of objects representing the response payload.</span>

<span class="sd">        The current ioHub response types are:</span>

<span class="sd">        #. RPC_RESULT</span>
<span class="sd">        #. GET_EVENTS_RESULT</span>
<span class="sd">        #. DEV_RPC_RESULT</span>
<span class="sd">        #. GET_DEV_LIST_RESULT</span>
<span class="sd">        #. GET_DEV_INTERFACE</span>
<span class="sd">        #. IOHUB_ERROR</span>
<span class="sd">        #. RPC_ERROR</span>

<span class="sd">        The ioHubConnection currently blocks until the request is fulfilled and and a response is</span>
<span class="sd">        received from the ioHub server.</span>

<span class="sd">        TODO: An aysnc. version could be added if desired. Instead of using callbacks, I prefer the</span>
<span class="sd">        idea of the client sending a request and getting a request ticket # back from the ioHub server</span>
<span class="sd">        right away, indicating that the job has been submitted for processing. The ioHubConnection can</span>
<span class="sd">        then ask the ioHub Server for the status of the job ticket based on ticket number.</span>
<span class="sd">        When the ticket number result is ready, it is sent back as the reply to the status request.</span>
<span class="sd">        This **aysnc. mode will be necessary** when the worker process is added to the ioHub framework</span>
<span class="sd">        to handle long running job requests from the PsychoPy process; for example to load an image</span>
<span class="sd">        into a shared memory space, perform long running computations, etc.</span>

<span class="sd">        Args:</span>
<span class="sd">            messageList (tuple): ioHub Server Message to send.</span>

<span class="sd">        Return (object): the message response from the ioHub Server process.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># send request to host, return is # bytes sent.</span>
        <span class="n">bytes_sent</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">sendTo</span><span class="p">(</span><span class="n">ioHubMessage</span><span class="p">)</span>

        <span class="c"># wait for response from ioHub server, return is result ( decoded already ), and Hub address (ip4,port).</span>
        <span class="n">result</span><span class="p">,</span><span class="n">address</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>

        <span class="c"># store result received in an address based dictionary (incase we ever support multiple ioHub Servers)</span>
        <span class="n">ioHubConnection</span><span class="o">.</span><span class="n">_addResponseToHistory</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="n">bytes_sent</span><span class="p">,</span><span class="n">address</span><span class="p">)</span>

        <span class="c"># check if the reply is an error or not. If it is, raise the error.</span>
        <span class="n">errorReply</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_isErrorReply</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">errorReply</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errorReply</span>

        <span class="c">#Otherwise return the result</span>
        <span class="k">return</span> <span class="n">result</span>

</div>
<div class="viewcode-block" id="ioHubConnection.updateGlobalHubTimeOffset"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.updateGlobalHubTimeOffset">[docs]</a>    <span class="k">def</span> <span class="nf">updateGlobalHubTimeOffset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">offset</span><span class="p">):</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;updateGlobalTimeOffset&#39;</span><span class="p">,(</span><span class="n">offset</span><span class="p">,)))</span>
        <span class="k">print</span> <span class="s">&#39;updateGlobalHubTimeOffset client got: &#39;</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="s">&#39; : &#39;</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_addResponseToHistory</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span><span class="n">result</span><span class="p">,</span><span class="n">bytes_sent</span><span class="p">,</span><span class="n">address</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a response from the ioHub to an ip:port based dictionary. Not used right now, but may be useful if we ever support</span>
<span class="sd">        a client connecting to &gt; 1 ioHub.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">address</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">cls</span><span class="o">.</span><span class="n">_replyDictionary</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_replyDictionary</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span><span class="n">bytes_sent</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_replyDictionary</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">=</span><span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
            <span class="n">cls</span><span class="o">.</span><span class="n">_replyDictionary</span><span class="p">[</span><span class="n">address</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result</span><span class="p">,</span><span class="n">bytes_sent</span><span class="p">))</span>



    <span class="k">def</span> <span class="nf">_sendExperimentInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">experimentInfoDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the experiment info from the experiment config file to the ioHub Server, which passes it to the ioDataStore,</span>
<span class="sd">        determines if the experiment already exists in the experiment file based on &#39;experiment_code&#39;, and returns a new</span>
<span class="sd">        or existing experiment ID based on that criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fieldOrder</span><span class="o">=</span><span class="p">((</span><span class="s">&#39;experiment_id&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="p">(</span><span class="s">&#39;code&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="s">&#39;description&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span>  <span class="p">,</span> <span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">,</span><span class="s">&#39;&#39;</span><span class="p">)</span> <span class="p">,</span> <span class="p">(</span><span class="s">&#39;total_sessions_to_run&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">values</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span><span class="n">defaultValue</span> <span class="ow">in</span> <span class="n">fieldOrder</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">experimentInfoDict</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">experimentInfoDict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">defaultValue</span><span class="p">)</span>

        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;setExperimentInfo&#39;</span><span class="p">,(</span><span class="n">values</span><span class="p">,)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experimentID</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_sendSessionInfo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">sessionInfoDict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends the experiment session info from the experiment config file and the values entered into the session dialog</span>
<span class="sd">        to the ioHub Server, which passes it to the ioDataStore, determines if the experiment already exists in the</span>
<span class="sd">        experiment file based on &#39;experiment_code&#39;, and returns a new or existing experiment ID based on that criteria.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experimentID</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="s">&quot;Experiment ID must be set by calling _sendExperimentInfo before calling _sendSessionInfo.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;code&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessionInfoDict</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="s">&quot;Code must be provided in sessionInfoDict ( StringCol(8) ).&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessionInfoDict</span><span class="p">:</span>
            <span class="n">sessionInfoDict</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;comments&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessionInfoDict</span><span class="p">:</span>
            <span class="n">sessionInfoDict</span><span class="p">[</span><span class="s">&#39;comments&#39;</span><span class="p">]</span><span class="o">=</span><span class="s">&#39;&#39;</span>
        <span class="k">if</span> <span class="s">&#39;user_variables&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sessionInfoDict</span><span class="p">:</span>
            <span class="n">sessionInfoDict</span><span class="p">[</span><span class="s">&#39;user_variables&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">{}</span>

        <span class="kn">import</span> <span class="nn">ujson</span>
        <span class="n">sessionInfoDict</span><span class="p">[</span><span class="s">&#39;user_variables&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">ujson</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sessionInfoDict</span><span class="p">[</span><span class="s">&#39;user_variables&#39;</span><span class="p">])</span>

        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;createExperimentSessionEntry&#39;</span><span class="p">,(</span><span class="n">sessionInfoDict</span><span class="p">,)))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">experimentSessionID</span><span class="o">=</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="ioHubConnection.initializeConditionVariableTable"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.initializeConditionVariableTable">[docs]</a>    <span class="k">def</span> <span class="nf">initializeConditionVariableTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conditionVariablesProvider</span><span class="p">):</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;initializeConditionVariableTable&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentID</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentSessionID</span><span class="p">,</span><span class="n">conditionVariablesProvider</span><span class="o">.</span><span class="n">_numpyConditionVariableDescriptor</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ioHubConnection.addRowToConditionVariableTable"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.addRowToConditionVariableTable">[docs]</a>    <span class="k">def</span> <span class="nf">addRowToConditionVariableTable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;addRowToConditionVariableTable&#39;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">experimentSessionID</span><span class="p">,</span><span class="n">data</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ioHubConnection.getDevice"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.getDevice">[docs]</a>    <span class="k">def</span> <span class="nf">getDevice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deviceName</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the ioHubDeviceView that has a matching name (based on the </span>
<span class="sd">        device : name property specified in the ioHub_config.yaml for the </span>
<span class="sd">        experiment). If no device is found matching the name, None is returned.</span>

<span class="sd">        i.e.</span>

<span class="sd">            keyboard = self.getDevice(&#39;kb&#39;)</span>
<span class="sd">            kb_events= keyboard.getEvent()</span>
<span class="sd">            </span>
<span class="sd">        This is the same as using the &#39;natural naming&#39; support in the </span>
<span class="sd">        ioHubExperimentRuntime class, i.e:</span>
<span class="sd">            </span>
<span class="sd">            keyboard = self.devices.kb</span>
<span class="sd">            kb_events= keyboard.getEvent()</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            deviceName (str): Name given to the ioHub Device to be returned</span>
<span class="sd">        Returns:</span>
<span class="sd">            device (ioHubDeviceView) : the experimentRuntime represention</span>
<span class="sd">                    for the device that matches the name provided.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">deviceName</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
        </div>
    <span class="k">def</span> <span class="nf">_getEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sends a request to the ioHub Server for any new device events from the global server event buffer.</span>
<span class="sd">        The events are returned and the global ioHub server event buffer is cleared.</span>

<span class="sd">        Args: None</span>
<span class="sd">        Return(tuple): list of events, or empty list if no events have occurred since last call</span>
<span class="sd">              to getEvents() or clearEvents(). Each event in the list is a tuple containing the ordered</span>
<span class="sd">              attributes of the event constructor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;GET_EVENTS&#39;</span><span class="p">,))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="ioHubConnection.getEvents"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.getEvents">[docs]</a>    <span class="k">def</span> <span class="nf">getEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deviceLabel</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">asType</span><span class="o">=</span><span class="s">&#39;namedtuple&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve any events that have been collected by the ioHub server from monitored devices</span>
<span class="sd">        since the last call to getEvents() or since the last call to clearEvents().</span>

<span class="sd">        By default all events for all monitored devices are returned, with each event being</span>
<span class="sd">        represented as a dictionary of event attributes. When events are retrieved from an event buffer,</span>
<span class="sd">        they are removed from the buffer as well.</span>

<span class="sd">        Args:</span>
<span class="sd">            deviceLabel (str): optional : if specified, indicates to only retrieve events for</span>
<span class="sd">                         the device with the associated label name. None (default) returns</span>
<span class="sd">                         all device events.</span>
<span class="sd">            asType (str): optional : indicated how events should be represented when they are returned.</span>
<span class="sd">                         Default: &#39;dict&#39;</span>
<span class="sd">                Events are sent from the ioHub Process as lists of ordered attributes. This is the most</span>
<span class="sd">                efficient for data transmission, but not for readability.</span>

<span class="sd">                If you do want events to be kept in list form, set asType = &#39;list&#39;.</span>

<span class="sd">                Setting asType = &#39;dict&#39; (the default) converts the events lists to event dictionaries.</span>
<span class="sd">                This process is quite fast so the small conversion time is usually worth it given the</span>
<span class="sd">                huge benefit in usability within your program.</span>

<span class="sd">                Setting asType = &#39;object&#39; converts the events to their ioHub DeviceEvent class form.</span>
<span class="sd">                This can take a bit of time if the event list is long and currently there is not much</span>
<span class="sd">                benefit in doing so vs. treating events as dictionaries. This may change in</span>
<span class="sd">                the future. For now, it is suggested that the default, asType=&#39;dict&#39; setting be kept.</span>

<span class="sd">        Return (tuple): returns a list of event objects, where the object type is defined by the</span>
<span class="sd">                &#39;asType&#39; parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">r</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">if</span> <span class="n">deviceLabel</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">events</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_getEvents</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">events</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span>    
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
                <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="p">[</span><span class="n">deviceLabel</span><span class="p">]</span>
            <span class="n">r</span><span class="o">=</span><span class="n">d</span><span class="o">.</span><span class="n">getEvents</span><span class="p">()</span>
  
        <span class="k">if</span> <span class="n">r</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;list&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">r</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">conversionMethod</span><span class="o">=</span><span class="bp">None</span>
                <span class="k">if</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;dict&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eventListToDict</span>
                <span class="k">elif</span> <span class="n">asType</span> <span class="o">==</span> <span class="s">&#39;object&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eventListToObject</span>
                <span class="k">elif</span> <span class="n">asType</span> <span class="o">==</span><span class="s">&#39;namedtuple&#39;</span><span class="p">:</span>
                    <span class="n">conversionMethod</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_eventListToNamedTuple</span>

                <span class="k">if</span> <span class="n">conversionMethod</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">conversionMethod</span><span class="p">(</span><span class="n">el</span><span class="p">)</span> <span class="k">for</span> <span class="n">el</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>

                <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="ioHubConnection.clearEvents"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.clearEvents">[docs]</a>    <span class="k">def</span> <span class="nf">clearEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">deviceLabel</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clears all events from the global event buffer, or if deviceLabel is not None,</span>
<span class="sd">        clears the events only from a specific device event buffer.</span>
<span class="sd">        When the global event buffer is cleared, device level event buffers are not effected.</span>

<span class="sd">        Args:</span>
<span class="sd">            devicelabel (str): name of the device that should have it&#39;s event buffer cleared.</span>
<span class="sd">                         If None (the default), the device wide event buffer is cleared</span>
<span class="sd">                         and device level event buffers are not changed.</span>
<span class="sd">        Return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">deviceLabel</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">deviceLabel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;clearEventBuffer&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">if</span> <span class="n">deviceLabel</span> <span class="ow">and</span> <span class="n">deviceLabel</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;all&#39;</span><span class="p">:</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">clearEvents</span><span class="p">()</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deviceByLabel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">deviceLabel</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">d</span><span class="o">.</span><span class="n">clearEvents</span><span class="p">()</span>
                <span class="k">return</span> <span class="bp">True</span>
            <span class="k">return</span> <span class="bp">False</span>
</div>
<div class="viewcode-block" id="ioHubConnection.delay"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.delay">[docs]</a>    <span class="k">def</span> <span class="nf">delay</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">delay</span><span class="p">,</span><span class="n">checkHubInterval</span><span class="o">=</span><span class="mf">0.02</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pause the experiment execution for msec.usec interval, while checking the ioHub for</span>
<span class="sd">        any new events and retrieving them every &#39;checkHubInterval&#39; msec during the delay. Any events</span>
<span class="sd">        that are gathered during the delay period will be handed to the experiment the next time</span>
<span class="sd">        self.getEvents() is called, unless self.clearEvents() beforehand.</span>

<span class="sd">        It is important to allow the PyschoPy Process to periodically either call self.getEvents() events</span>
<span class="sd">        during long delaying in program execution so that a) the event queues</span>
<span class="sd">        to not reach the specified limits and start descarding old events when </span>
<span class="sd">        new events arrive, and b) so that a very large build up of events does</span>
<span class="sd">        not occur on the ioHub Process, that then takes multiple UDP packets</span>
<span class="sd">        to transmit to the experiment. This will slow event retrieval down</span>
<span class="sd">        unnecessarily. If you are using delay, may as well occationally have the</span>
<span class="sd">        experiment process occationally grab any new events from</span>
<span class="sd">        the ioHub process during it.</span>

<span class="sd">        Also keep in mind that calling self.clearEvents() after any long delays</span>
<span class="sd">        between calls to self.getEvents() or self.clearEvents() will clear</span>
<span class="sd">        events from the ioHub server so they are not uncessarily  sent to</span>
<span class="sd">        the experiment process if you do not need them (they are still being</span>
<span class="sd">        stored in the ioDataStore assuming the Device has event reporting</span>
<span class="sd">        enabled of course). </span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            delay (float/double): the sec.msec_usec period that the PsychoPy Process should wait</span>
<span class="sd">                              before returning from the function call.</span>
<span class="sd">            checkHubInterval (float/double): the sec.msec_usec interval after which any ioHub</span>
<span class="sd">                              events will be retrieved (by calling self.getEvents) and stored</span>
<span class="sd">                              in a local buffer. This is repeated every checkHubInterval sec.msec_usec until</span>
<span class="sd">                              the method completes. Default is every 0.01 sec ( 10.0 msec ).</span>

<span class="sd">        Return(float/double): actual duration of delay in sec.msec_usec format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">stime</span><span class="o">=</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">()</span>
        <span class="n">targetEndTime</span><span class="o">=</span><span class="n">stime</span><span class="o">+</span><span class="n">delay</span>

        <span class="k">if</span> <span class="n">checkHubInterval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">checkHubInterval</span><span class="o">=</span><span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">checkHubInterval</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">remainingSec</span><span class="o">=</span><span class="n">targetEndTime</span><span class="o">-</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">()</span>
            <span class="k">while</span> <span class="n">remainingSec</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remainingSec</span> <span class="o">&lt;</span> <span class="n">checkHubInterval</span><span class="o">+</span><span class="mf">0.001</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">remainingSec</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">checkHubInterval</span><span class="p">)</span>
                    <span class="n">events</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getEvents</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">events</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">allEvents</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">events</span><span class="p">)</span>
                    <span class="n">pumpLocalMessageQueue</span><span class="p">()</span>
                
                <span class="n">remainingSec</span><span class="o">=</span><span class="n">targetEndTime</span><span class="o">-</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">()</span>
            
            <span class="k">while</span> <span class="p">(</span><span class="n">targetEndTime</span><span class="o">-</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">())</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="o">-</span><span class="mf">0.001</span><span class="p">)</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">targetEndTime</span><span class="o">-</span><span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">())</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="k">pass</span>
                
        <span class="k">return</span> <span class="n">Computer</span><span class="o">.</span><span class="n">currentTime</span><span class="p">()</span><span class="o">-</span><span class="n">stime</span>
</div>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eventListToObject</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an ioHub event that is current represented as an ordered list of values, and return the correct</span>
<span class="sd">        ioHub.devices.DeviceEvent subclass for the given event type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eclass</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">getClass</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">[</span><span class="n">DeviceEvent</span><span class="o">.</span><span class="n">EVENT_TYPE_ID_INDEX</span><span class="p">])</span>
        <span class="n">combo</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">eclass</span><span class="o">.</span><span class="n">CLASS_ATTRIBUTE_NAMES</span><span class="p">,</span><span class="n">eventValueList</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">combo</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">eclass</span><span class="o">.</span><span class="n">createEventAsClass</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eventListToDict</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an ioHub event that is current represented as an ordered list of values, and return the event as a</span>
<span class="sd">        dictionary of attribute name, attribute values for the object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">,</span><span class="nb">dict</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">eventValueList</span>
            <span class="n">eclass</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">getClass</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">[</span><span class="n">DeviceEvent</span><span class="o">.</span><span class="n">EVENT_TYPE_ID_INDEX</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">eclass</span><span class="o">.</span><span class="n">createEventAsDict</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;---------------&#39;</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: eventValueList: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">)</span>
            <span class="k">print</span> <span class="s">&#39;---------------&#39;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_eventListToNamedTuple</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert an ioHub event that is currently represented as an ordered list of values, and return the event as a</span>
<span class="sd">        namedtuple.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">eventValueList</span>
            <span class="n">eclass</span><span class="o">=</span><span class="n">EventConstants</span><span class="o">.</span><span class="n">getClass</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">[</span><span class="n">DeviceEvent</span><span class="o">.</span><span class="n">EVENT_TYPE_ID_INDEX</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">eclass</span><span class="o">.</span><span class="n">createEventAsNamedTuple</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&#39;---------------&#39;</span>
            <span class="k">print</span> <span class="s">&quot;ERROR: eventValueList: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">eventValueList</span><span class="p">)</span>
            <span class="n">ioHub</span><span class="o">.</span><span class="n">printExceptionDetailsToStdErr</span><span class="p">()</span>
            <span class="k">print</span> <span class="s">&#39;---------------&#39;</span>

<div class="viewcode-block" id="ioHubConnection.sendEvents"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.sendEvents">[docs]</a>    <span class="k">def</span> <span class="nf">sendEvents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">events</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send 1 - N ExperimentDevice Events (currently MessageEvents are supported) to the ioHub Process</span>
<span class="sd">        for storage. Each object in the events list must be a tuple containing the ordered</span>
<span class="sd">        attributes of the event constructor.</span>

<span class="sd">        Args:</span>
<span class="sd">            events(tuple): list of ExperimentEvents</span>
<span class="sd">        Return (int): the number of events that the ioHub Server process successfully parsed and saved.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eventList</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">events</span><span class="p">:</span>
            <span class="n">eventList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">_asList</span><span class="p">())</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;EVENT_TX&#39;</span><span class="p">,</span><span class="n">eventList</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span>
</div>
<div class="viewcode-block" id="ioHubConnection.sendMessageEvent"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.sendMessageEvent">[docs]</a>    <span class="k">def</span> <span class="nf">sendMessageEvent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">text</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span><span class="n">offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span><span class="n">sec_time</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create and send a MessageEvent to the ioHub Server Process for storage</span>
<span class="sd">        with the rest of the event data.</span>

<span class="sd">        Args:</span>
<span class="sd">          text (str): The text message for the message event. Can be up to 128 characters in length.</span>
<span class="sd">          prefix (str): A 0 - 3 character prefix for the message that can be used to sort or group</span>
<span class="sd">                        messages by &#39;types&#39;</span>
<span class="sd">          offset (float): The usec offset to apply to the time stamp of the message event.</span>
<span class="sd">                          If you send the event before or after the time the event actually occurred,</span>
<span class="sd">                          and you know what the offset value is, you can provide it here and it</span>
<span class="sd">                          will be applied to the ioHub time stamp for the event.</span>
<span class="sd">          usec_time (int/long): Since (at least on Windows currently) if you use the ioHub timers,</span>
<span class="sd">                                the time-base of the experiment process is identical to that of the ioHub</span>
<span class="sd">                                server process, then you can specific the ioHub time (in usecs) for</span>
<span class="sd">                                experiment events right in the experiment process itself.</span>

<span class="sd">        Return (bool): True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;EVENT_TX&#39;</span><span class="p">,[</span><span class="n">MessageEvent</span><span class="o">.</span><span class="n">_createAsList</span><span class="p">(</span><span class="n">text</span><span class="p">,</span><span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span><span class="n">msg_offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span><span class="n">sec_time</span><span class="o">=</span><span class="n">sec_time</span><span class="p">),]))</span>
        <span class="k">return</span> <span class="bp">True</span>
</div>
<div class="viewcode-block" id="ioHubConnection.sendMessages"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.sendMessages">[docs]</a>    <span class="k">def</span> <span class="nf">sendMessages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">messageList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Same as the sendMessage method, but accepts a list of lists of message arguments,</span>
<span class="sd">        so you can have N messages created and sent at once.</span>

<span class="sd">        Args:</span>
<span class="sd">            messageList(tuple): list of lists, where each inner list represents a MessageEvent in list form</span>
<span class="sd">                           (i.e as an ordered list of event attribute value as would be passed to the</span>
<span class="sd">                            MessageEvent constructor)</span>
<span class="sd">        Return (bool): True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">msgEvents</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">messageList</span><span class="p">:</span>
            <span class="n">msgEvents</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MessageEvent</span><span class="o">.</span><span class="n">_createAsList</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;EVENT_TX&#39;</span><span class="p">,</span><span class="n">msgEvents</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="c"># client utility methods.</span></div>
    <span class="k">def</span> <span class="nf">_getDeviceList</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;EXP_DEVICE&#39;</span><span class="p">,</span><span class="s">&#39;GET_DEV_LIST&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

<div class="viewcode-block" id="ioHubConnection.shutdown"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.shutdown">[docs]</a>    <span class="k">def</span> <span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutDownServer</span><span class="p">()</span></div>
<div class="viewcode-block" id="ioHubConnection.quit"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.quit">[docs]</a>    <span class="k">def</span> <span class="nf">quit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Same as shutdown, but has same name as psychopy core.quit() so maybe easier for psychopy users to remember.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_shutDownServer</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_shutDownServer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">sendTo</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;shutDown&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">udp_client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="p">:</span>
                <span class="n">r</span><span class="o">=</span><span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&#39;ioHub Server Process Completed With Code: &#39;</span><span class="p">,</span><span class="n">r</span>
        <span class="k">except</span> <span class="n">psutil</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Warning: TimeoutExpired, Killing ioHub Server process.&quot;</span>
            <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;Warning: Unhandled Exception. Killing ioHub Server process.&quot;</span>
            <span class="k">if</span> <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="p">:</span>
                <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
            <span class="n">ioHub</span><span class="o">.</span><span class="n">printExceptionDetailsToStdErr</span><span class="p">()</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_server_process</span><span class="o">=</span><span class="bp">None</span>
            <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcessID</span><span class="o">=</span><span class="bp">None</span>
            <span class="n">Computer</span><span class="o">.</span><span class="n">ioHubServerProcess</span><span class="o">=</span><span class="bp">None</span>
        <span class="k">return</span> <span class="bp">True</span>

<div class="viewcode-block" id="ioHubConnection.currentSec"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.currentSec">[docs]</a>    <span class="k">def</span> <span class="nf">currentSec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the sec.msec-usec time retrieved from the ioHub Server process. This method sends a message to</span>
<span class="sd">        the ioHub Process asking for the currentSec time on that process, and returns the result.</span>

<span class="sd">        Therefore there will be a small delay in getting the current ioHub Process time, and this means</span>
<span class="sd">        current_ioHub_secs = self.currentSec()-DELAY, where delay is the time from when the</span>
<span class="sd">        ioHub Server Process read the currentSec time to when the PsychoPy process received the reply.</span>

<span class="sd">        **Note:** On Windows, both the PsychoPy and ioHub Processes use the same time base</span>
<span class="sd">               if you call one of the ioHub Experiment Runtime time methods, so there is **no need**</span>
<span class="sd">               to call this method to get the current ioHub Process time.</span>

<span class="sd">               It will be more accurate to call one of the following time methods, which gives you</span>
<span class="sd">               the current ioHub Process and PsychoPy Process time, as they are the same:</span>

<span class="sd">               * ioHub.highPrecisionTimer() : returns sec.msec-usec time</span>
<span class="sd">               * ioHub.devices.Computer.getSec() : returns sec.msec-usec time</span>


<span class="sd">               If running your experiment within the run() method of a class extended from</span>
<span class="sd">               ioHub.experiment.ioHubExperimentRuntime, you can also use:</span>

<span class="sd">               * self.currentSec()</span>

<span class="sd">        Args: None</span>
<span class="sd">        Return (float/double): The ioHub Process sec.msec-usec time when the request was processed</span>
<span class="sd">                               by the ioHub Server Process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;currentSec&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ioHubConnection.enableHighPriority"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.enableHighPriority">[docs]</a>    <span class="k">def</span> <span class="nf">enableHighPriority</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">disable_gc</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;        </span>
<span class="sd">        Sets the priority of the ioHub Process to high priority</span>
<span class="sd">        and optionally (default is False) disable the python GC. This is</span>
<span class="sd">        useful for the duration of a trial, for example, where you enable at</span>
<span class="sd">        start of trial and disable at end of trial. Improves Windows</span>
<span class="sd">        sloppiness greatly in general.</span>

<span class="sd">        Args:</span>
<span class="sd">            disable_gc(bool): True = Turn of the Python Garbage Collector. </span>
<span class="sd">                              False = Leave the Garbage Collector running.</span>
<span class="sd">                              Default: True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;enableHighPriority&#39;</span><span class="p">,(</span><span class="n">disable_gc</span><span class="p">,)))</span>
        </div>
<div class="viewcode-block" id="ioHubConnection.disableHighPriority"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.disableHighPriority">[docs]</a>    <span class="k">def</span> <span class="nf">disableHighPriority</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the priority of the ioHub Process back to normal priority</span>
<span class="sd">        and enables the python GC. In general you would call </span>
<span class="sd">        enableHighPriority() at start of trial and call </span>
<span class="sd">        disableHighPriority() at end of trial.</span>

<span class="sd">        Return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;disableHighPriority&#39;</span><span class="p">))</span>
        </div>
<div class="viewcode-block" id="ioHubConnection.getProcessAffinity"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.getProcessAffinity">[docs]</a>    <span class="k">def</span> <span class="nf">getProcessAffinity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the ioHub Process Affinity setting, as a list of &#39;processor&#39; id&#39;s</span>
<span class="sd">        (from 0 to getSystemProcessorCount()-1) that the ioHub Process is able to</span>
<span class="sd">        run on.</span>

<span class="sd">        For example, on a 2 core CPU with hyper-threading, the possible &#39;processor&#39; list would be</span>
<span class="sd">        [0,1,2,3], and by default the ioHub Process can run on any of these &#39;processors&#39;, so:</span>


<span class="sd">        ioHubCPUs=self.getProcessAffinity()</span>
<span class="sd">        print ioHubCPUs</span>

<span class="sd">        &gt;&gt; [0,1,2,3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;getProcessAffinity&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ioHubConnection.setProcessAffinity"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.setProcessAffinity">[docs]</a>    <span class="k">def</span> <span class="nf">setProcessAffinity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">processorList</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the ioHub Process Affinity based on processorList, a list of &#39;processor&#39; id&#39;s</span>
<span class="sd">        (from 0 to getSystemProcessorCount()-1) that the ioHub Process is able to run on.</span>

<span class="sd">        For example, on a 2 core CPU with hyper-threading, the possible &#39;processor&#39; list would be [0,1,2,3],</span>
<span class="sd">        and by default ioHub server processes can run on any of these &#39;processors&#39;. To set the ioHub Process to</span>
<span class="sd">        only run on core 2 of the CPU, you would call:</span>

<span class="sd">        self.setProcessAffinity([2,3])</span>

<span class="sd">        # check the ioHub Process affinities</span>
<span class="sd">        ioHubCPUs=self.getProcessAffinity()</span>
<span class="sd">        print ioHubCPUs</span>

<span class="sd">        &gt;&gt; [2,3]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;setProcessAffinity&#39;</span><span class="p">,</span><span class="n">processorList</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
<div class="viewcode-block" id="ioHubConnection.flushIODataStoreFile"><a class="viewcode-back" href="../../iohub/api/iohub_connection.html#ioHub.client.ioHubConnection.flushIODataStoreFile">[docs]</a>    <span class="k">def</span> <span class="nf">flushIODataStoreFile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manually tell the ioDataStore to flush any events it has beuffered for storage from memory to disk.&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">r</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sendToHubServer</span><span class="p">((</span><span class="s">&#39;RPC&#39;</span><span class="p">,</span><span class="s">&#39;flushIODataStoreFile&#39;</span><span class="p">))</span>
        <span class="k">print</span> <span class="s">&quot;flushIODataStoreFile: &quot;</span><span class="p">,</span><span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">r</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div>
    <span class="k">def</span> <span class="nf">_isErrorReply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ioHub</span><span class="o">.</span><span class="n">isIterable</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ioHub</span><span class="o">.</span><span class="n">isIterable</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="nb">unicode</span><span class="p">))</span> <span class="ow">and</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;ERROR&#39;</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ioHubConnectionException</span><span class="p">(</span><span class="s">&#39;Response from ioHub should always be iterable and have a length &gt; 0&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutDownServer</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span></div>
</pre></div>

</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2013, iSolver Software Solutions.<br/>
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>